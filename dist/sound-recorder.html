<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ä¸“ä¸šç½‘é¡µå½•éŸ³è½¯ä»¶ï¼ˆSafari é€‚é…ç‰ˆï¼‰</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
            color: #1d1d1f;
            touch-action: manipulation;
        }
        .container {
            background-color: #ffffff;
            border-radius: 18px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 32px 16px;
            width: 90%;
            max-width: 460px;
            text-align: center;
        }
        h1 { font-size: 24px; margin-bottom: 20px; font-weight: 600; }
        select {
            width: 100%;
            padding: 10px;
            margin: 16px 0;
            border-radius: 10px;
            border: 1px solid #d2d2d7;
            background-color: #f9f9f9;
            font-size: 16px;
        }
        /* æ–°å¢ï¼šSafari ä¸“å±è·å–æƒé™æŒ‰é’®ï¼ˆé»˜è®¤éšè—ï¼Œä»… Safari æ˜¾ç¤ºï¼‰ */
        .safari-get-permission-btn {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 0 0 16px 0;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: none; /* é»˜è®¤éšè— */
        }
        .safari-get-permission-btn:disabled {
            background-color: #c7c7cc;
            cursor: not-allowed;
        }
        .safari-get-permission-btn:hover:not(:disabled) {
            background-color: #005edc;
        }
        .waveform-container {
            position: relative;
            width: 100%;
            height: 160px;
            margin-bottom: 12px;
        }
        canvas {
            width: 100%;
            height: 100%;
            background-color: #f2f2f5;
            border-radius: 12px;
        }
        .fullscreen-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            transition: background-color 0.2s ease;
            z-index: 10;
        }
        .fullscreen-btn:hover {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .waveform-container:fullscreen,
        .waveform-container:-webkit-full-screen {
            width: 100vw;
            height: 100vh;
            margin: 0;
            background-color: #f2f2f5;
        }
        .waveform-container:fullscreen canvas,
        .waveform-container:-webkit-full-screen canvas {
            border-radius: 0;
            background-color: #f2f2f5;
        }
        #timer {
            font-size: 28px;
            font-weight: bold;
            margin: 8px 0;
            color: #007aff;
        }
        #decibel {
            font-size: 18px;
            color: #86868b;
            margin: 4px 0;
        }
        .volume-meter {
            height: 16px;
            background-color: #e5e5ea;
            border-radius: 8px;
            overflow: hidden;
            margin: 16px 0;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .volume-level {
            height: 100%;
            width: 0%;
            border-radius: 8px;
            transition: width 0.15s ease, background-color 0.2s ease;
            position: relative;
        }
        .volume-level::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 8px;
            background: linear-gradient(90deg, #30d158 60%, #ff9f0a 85%, #ff453a);
            opacity: 0.3;
        }
        .buttons {
            display: flex;
            justify-content: space-around;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            flex: 1;
            min-width: 100px;
        }
        button:hover:not(:disabled) {
            background-color: #005edc;
        }
        button:disabled {
            background-color: #c7c7cc;
            cursor: not-allowed;
        }
        audio {
            width: 100%;
            margin-top: 20px;
        }
        #status {
            font-size: 15px;
            color: #86868b;
            margin-bottom: 12px;
            min-height: 22px;
        }
        .error {
            color: #ff3b30;
            font-weight: 500;
        }
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .permission-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            border-radius: 18px;
            padding: 32px;
            width: 85%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }
        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: #007aff;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .modal-desc {
            color: #86868b;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        .modal-button {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        .modal-button:hover {
            background-color: #005edc;
        }
    </style>
</head>
<body>
    <div class="permission-modal" id="permissionModal">
        <div class="modal-content">
            <div class="modal-icon">ğŸ™ï¸</div>
            <div class="modal-title">éœ€è¦éº¦å…‹é£æƒé™</div>
            <div class="modal-desc">ä¸ºäº†è®©ä½ ä½¿ç”¨å½•éŸ³åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®ä½ çš„éº¦å…‹é£ã€‚æƒé™ä»…ç”¨äºå½•éŸ³ï¼Œä¸ä¼šæ”¶é›†å…¶ä»–ä¿¡æ¯ã€‚</div>
            <button class="modal-button" id="allowMicBtn">å…è®¸è®¿é—®éº¦å…‹é£</button>
        </div>
    </div>

    <div class="container">
        <h1>å½•éŸ³æœºï¼ˆæ³¢å½¢å®æ—¶æ˜¾ç¤ºï¼‰</h1>
        
        <!-- æ–°å¢ï¼šSafari ä¸“å±è·å–éº¦å…‹é£æƒé™æŒ‰é’®ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <button class="safari-get-permission-btn" id="safariGetMicPermissionBtn">è·å–éº¦å…‹é£æƒé™</button>
        
        <select id="micSelect">
            <option value="">æœªåŠ è½½éº¦å…‹é£</option>
        </select>
        
        <div class="waveform-container" id="waveformContainer">
            <canvas id="waveform"></canvas>
            <div class="fullscreen-btn" id="fullscreenBtn" title="å…¨å±é¢‘ç‡å›¾">â›¶</div>
        </div>
        
        <div id="status">æ­£åœ¨æ£€æŸ¥éº¦å…‹é£æƒé™...</div>
        
        <div id="timer">00:00</div>
        <div id="decibel">-60.0 dB</div>
        
        <div class="volume-meter">
            <div class="volume-level" id="volumeLevel"></div>
        </div>
        
        <div class="buttons">
            <button id="startBtn" disabled>å¼€å§‹å½•åˆ¶</button>
            <button id="stopBtn" disabled>åœæ­¢å½•åˆ¶</button>
            <button id="saveBtn" disabled>ä¿å­˜å½•éŸ³</button>
        </div>
        
        <audio id="audioPlayback" controls></audio>
    </div>

    <script>
        let stream = null;
        let mediaRecorder = null;
        let analyser = null;
        let playAnalyser = null;
        let freqArray = null;
        let playFreqArray = null;
        let recordedBlob = null;
        let isRecording = false;
        let isPlaying = false;
        let startTime = null;
        let timerInterval = null;
        let audioContext = null;
        let audioTotalDuration = 0;
        let lastDbUpdateTime = 0;
        const dbUpdateInterval = 200;
        const waveformContainer = document.getElementById('waveformContainer');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const canvas = document.getElementById('waveform');
        const permissionModal = document.getElementById('permissionModal');
        const allowMicBtn = document.getElementById('allowMicBtn');
        // æ–°å¢ï¼šSafari ä¸“å±æŒ‰é’® DOM å˜é‡
        const safariGetMicPermissionBtn = document.getElementById('safariGetMicPermissionBtn');

        const micSelect = document.getElementById('micSelect');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const saveBtn = document.getElementById('saveBtn');
        const status = document.getElementById('status');
        const timerDisplay = document.getElementById('timer');
        const decibelDisplay = document.getElementById('decibel');
        const volumeLevel = document.getElementById('volumeLevel');
        const ctx = canvas.getContext('2d');
        const audioPlayback = document.getElementById('audioPlayback');

        // ========== æ–°å¢ï¼šæ ¸å¿ƒ1ï¼šæ£€æµ‹æ˜¯å¦ä¸º Safari æµè§ˆå™¨ï¼ˆç²¾å‡†åˆ¤æ–­ï¼‰ ==========
        function isSafari() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isSafariBrowser = /safari/.test(userAgent) && !/chrome|firefox|edge|brave|opera/.test(userAgent);
            return isSafariBrowser;
        }

        // ========== æ–°å¢ï¼šæ ¸å¿ƒ2ï¼šSafari é€‚é…åˆå§‹åŒ–ï¼ˆæ§åˆ¶å¼¹çª—/æŒ‰é’®æ˜¾ç¤ºéšè—ï¼‰ ==========
        function initSafariAdaptation() {
            const isSafariBrowser = isSafari();
            if (isSafariBrowser) {
                // Safari æµè§ˆå™¨ï¼šéšè—å¼¹çª—ï¼Œæ˜¾ç¤ºé¡µé¢å†…æŒ‰é’®ï¼Œæ›´æ–°çŠ¶æ€æç¤º
                permissionModal.style.display = 'none'; // å½»åº•éšè—å¼¹çª—ï¼ˆé¿å…showç±»å¹²æ‰°ï¼‰
                safariGetMicPermissionBtn.style.display = 'block';
                status.textContent = 'è¯·ç‚¹å‡»ã€Œè·å–éº¦å…‹é£æƒé™ã€æŒ‰é’®ä»¥ç»§ç»­';
            } else {
                // é Safari æµè§ˆå™¨ï¼šéšè—ä¸“å±æŒ‰é’®ï¼Œä¿æŒåŸæœ‰å¼¹çª—é€»è¾‘ä¸å˜
                safariGetMicPermissionBtn.style.display = 'none';
            }
        }

        // ========== æ–°å¢ï¼šæ ¸å¿ƒ3ï¼šSafari æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆç»‘å®šæƒé™è¯·æ±‚é€»è¾‘ï¼‰ ==========
        function bindSafariBtnEvent() {
            safariGetMicPermissionBtn.addEventListener('click', async function() {
                // ç¦ç”¨æŒ‰é’®ï¼Œé¿å…é‡å¤ç‚¹å‡»
                this.disabled = true;
                this.textContent = 'æ­£åœ¨è¯·æ±‚æƒé™...';
                status.classList.remove('error');
                status.textContent = 'æ­£åœ¨è¯·æ±‚ç³»ç»Ÿéº¦å…‹é£æƒé™...';

                try {
                    // ç›´æ¥å¤ç”¨åŸæœ‰æ ¸å¿ƒé€»è¾‘ï¼šåŠ è½½éº¦å…‹é£å¹¶æ•è·æµ
                    await loadMicrophonesAndCapture();
                    // Safari æƒé™è¯·æ±‚æˆåŠŸåï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
                    this.textContent = 'æƒé™å·²è·å–';
                } catch (err) {
                    // å¤±è´¥åé‡ç½®æŒ‰é’®çŠ¶æ€ï¼Œæ–¹ä¾¿é‡æ–°å°è¯•
                    this.disabled = false;
                    this.textContent = 'é‡æ–°è·å–éº¦å…‹é£æƒé™';
                    // é”™è¯¯æç¤ºå·²åœ¨ loadMicrophonesAndCapture ä¸­å¤„ç†ï¼Œæ— éœ€é‡å¤ç¼–å†™
                }
            });
        }

        // ========== æ ¸å¿ƒä¿®å¤1ï¼šæƒé™æ£€æµ‹ + å…¼å®¹ iOS ==========
        async function checkMicPermission() {
            // å…ˆæ‰§è¡Œ Safari é€‚é…åˆå§‹åŒ–ï¼ˆä¼˜å…ˆä¿è¯ Safari æ ·å¼æ­£ç¡®ï¼‰
            initSafariAdaptation();
            // ç»‘å®š Safari æŒ‰é’®äº‹ä»¶
            bindSafariBtnEvent();

            // é Safari æµè§ˆå™¨ï¼Œç»§ç»­åŸæœ‰æƒé™æ£€æµ‹é€»è¾‘ï¼ˆä¸æ”¹åŠ¨ï¼‰
            const isSafariBrowser = isSafari();
            if (isSafariBrowser) return; // Safari å·²é€šè¿‡æŒ‰é’®è§¦å‘ï¼Œè·³è¿‡åŸæœ‰å¼¹çª—é€»è¾‘

            try {
                // å…ˆæ£€æµ‹ mediaDevices æ˜¯å¦å­˜åœ¨ï¼ˆä¿®å¤ undefined é—®é¢˜ï¼‰
                if (!navigator || !navigator.mediaDevices) {
                    throw new Error('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·æ›´æ–°æµè§ˆå™¨è‡³æœ€æ–°ç‰ˆæœ¬');
                }

                // æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒæƒé™æŸ¥è¯¢ API
                if (navigator.permissions) {
                    const permissionStatus = await navigator.permissions.query({
                        name: 'microphone'
                    });

                    switch (permissionStatus.state) {
                        case 'granted':
                            status.textContent = 'éº¦å…‹é£æƒé™å·²æˆäºˆï¼Œæ­£åœ¨åŠ è½½è®¾å¤‡...';
                            await loadMicrophonesAndCapture();
                            break;
                        case 'denied':
                            status.textContent = 'éº¦å…‹é£æƒé™å·²è¢«æ‹’ç»ï¼Œè¯·å‰å¾€æµè§ˆå™¨è®¾ç½®å¼€å¯éº¦å…‹é£æƒé™';
                            status.classList.add('error');
                            break;
                        case 'prompt':
                            status.textContent = 'è¯·ç‚¹å‡»å¼¹çª—ä¸­çš„æŒ‰é’®ä»¥è·å–éº¦å…‹é£æƒé™...';
                            permissionModal.classList.add('show');
                            break;
                    }

                    permissionStatus.addEventListener('change', () => {
                        if (permissionStatus.state === 'granted') {
                            status.classList.remove('error');
                            checkMicPermission();
                        }
                    });
                } else {
                    // ä¸æ”¯æŒæƒé™æŸ¥è¯¢ï¼Œç›´æ¥æ˜¾ç¤ºå¼¹çª—
                    status.textContent = 'è¯·ç‚¹å‡»å¼¹çª—ä¸­çš„æŒ‰é’®ä»¥è·å–éº¦å…‹é£æƒé™...';
                    permissionModal.classList.add('show');
                }
            } catch (err) {
                status.textContent = 'æƒé™æ£€æµ‹å¤±è´¥ï¼š' + err.message;
                status.classList.add('error');
                permissionModal.classList.add('show'); // é™çº§æ˜¾ç¤ºå¼¹çª—
            }
        }

        // ========== æ ¸å¿ƒä¿®å¤2ï¼šä¿®æ­£å¤§å°å†™ + è°ƒæ•´ enumerateDevices è°ƒç”¨æ—¶æœºï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰ ==========
        async function loadMicrophonesAndCapture() {
            try {
                // æ­¥éª¤1ï¼šå…ˆè·å–åª’ä½“æµæƒé™ï¼ˆSafari è¦æ±‚å¿…é¡»å…ˆæˆæƒï¼Œå†æšä¸¾è®¾å¤‡ï¼‰
                const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // æ­¥éª¤2ï¼šä¿®æ­£å¤§å°å†™ï¼šnavigator.mediaDevices.enumerateDevices()ï¼ˆD å¤§å†™ï¼‰
                const devices = await navigator.mediaDevices.enumerateDevices();
                const mics = devices.filter(d => d.kind === 'audioinput');

                // æ­¥éª¤3ï¼šé‡Šæ”¾ä¸´æ—¶æµï¼ˆé¿å…å ç”¨è®¾å¤‡ï¼‰
                tempStream.getTracks().forEach(track => track.stop());

                micSelect.innerHTML = '';
                if (mics.length === 0) {
                    micSelect.innerHTML = '<option>æœªæ£€æµ‹åˆ°éº¦å…‹é£</option>';
                    status.textContent = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œæ— æ³•æ•è·å£°éŸ³';
                    status.classList.add('error');
                    return;
                }

                // å¡«å……éº¦å…‹é£åˆ—è¡¨
                mics.forEach((mic, i) => {
                    const opt = document.createElement('option');
                    opt.value = mic.deviceId;
                    opt.text = mic.label || `éº¦å…‹é£ ${i + 1}`; // Safari æˆæƒåæ‰ä¼šæ˜¾ç¤º label
                    micSelect.appendChild(opt);
                });

                // æ•è·ç¬¬ä¸€ä¸ªéº¦å…‹é£çš„æµ
                const firstMicDeviceId = mics[0].deviceId;
                micSelect.value = firstMicDeviceId;
                await captureAudioStream(firstMicDeviceId);
            } catch (err) {
                if (err.name === 'NotAllowedError') {
                    const tip = isSafari() 
                        ? 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·å‰å¾€ã€Œè®¾ç½® â†’ Safari â†’ éº¦å…‹é£ã€å¼€å¯'
                        : 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·å‰å¾€æµè§ˆå™¨è®¾ç½®å¼€å¯éº¦å…‹é£æƒé™';
                    status.textContent = tip;
                } else if (err.name === 'NotFoundError') {
                    status.textContent = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œè¯·æ£€æŸ¥ç¡¬ä»¶è¿æ¥';
                } else {
                    status.textContent = 'åŠ è½½éº¦å…‹é£å¤±è´¥ï¼š' + err.message;
                }
                status.classList.add('error');
            }
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.addEventListener('load', () => {
            drawFrequencySpectrum();
            checkMicPermission();
        });

        // ========== å…¶ä½™åŠŸèƒ½ä»£ç ï¼ˆå®Œå…¨ä¿ç•™ä½ çš„åŸå§‹ä»£ç ï¼Œæ— ä»»ä½•ä¿®æ”¹ï¼‰ ==========
        function resizeCanvas() {
            const containerWidth = waveformContainer.clientWidth;
            const containerHeight = waveformContainer.clientHeight;
            canvas.width = containerWidth * devicePixelRatio;
            canvas.height = containerHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function calculateDecibel(freqData) {
            let sum = 0;
            for (let i = 0; i < freqData.length; i++) {
                sum += freqData[i] * freqData[i];
            }
            const rms = Math.sqrt(sum / freqData.length);
            const db = 20 * Math.log10(rms / 255 || 0.0001);
            return Math.max(db, -60).toFixed(1);
        }

        function formatTime(seconds) {
            const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(Math.floor(seconds % 60)).padStart(2, '0');
            return `${mins}:${secs}`;
        }

        function formatPlayTime(current, total) {
            return `${formatTime(current)}/${formatTime(total)}`;
        }

        function drawFrequencySpectrum() {
            requestAnimationFrame(drawFrequencySpectrum);
            const now = Date.now();

            let currentFreqArray = null;
            let currentDb = "-60.0";
            let volumePercent = 0;
            let needUpdateDb = false;

            if (isRecording && analyser && freqArray) {
                analyser.getByteFrequencyData(freqArray);
                currentFreqArray = freqArray;
                volumePercent = (Math.max(...freqArray) / 255) * 100;
                if (now - lastDbUpdateTime >= dbUpdateInterval) {
                    currentDb = calculateDecibel(freqArray);
                    needUpdateDb = true;
                    lastDbUpdateTime = now;
                }
            } else if (isPlaying && playAnalyser && playFreqArray) {
                playAnalyser.getByteFrequencyData(playFreqArray);
                currentFreqArray = playFreqArray;
                volumePercent = (Math.max(...playFreqArray) / 255) * 100;
                if (now - lastDbUpdateTime >= dbUpdateInterval) {
                    currentDb = calculateDecibel(playFreqArray);
                    needUpdateDb = true;
                    lastDbUpdateTime = now;
                }
            } else if (analyser && freqArray && !isRecording && !isPlaying) {
                analyser.getByteFrequencyData(freqArray);
                currentFreqArray = freqArray;
                volumePercent = (Math.max(...freqArray) / 255) * 100;
                if (now - lastDbUpdateTime >= dbUpdateInterval) {
                    currentDb = calculateDecibel(freqArray);
                    needUpdateDb = true;
                    lastDbUpdateTime = now;
                }
            } else {
                const isFullscreen = !!document.fullscreenElement || !!document.webkitFullscreenElement;
                ctx.fillStyle = isFullscreen ? '#f2f2f5' : '#f2f2f5';
                ctx.fillRect(0, 0, canvas.clientWidth, canvas.clientHeight);
                volumeLevel.style.width = '0%';
                needUpdateDb = true;
            }

            if (needUpdateDb) {
                decibelDisplay.textContent = `${currentDb} dB`;
            }

            if (currentFreqArray) {
                const isFullscreen = !!document.fullscreenElement || !!document.webkitFullscreenElement;
                const bgColor = isFullscreen ? '#f2f2f5' : '#f2f2f5';
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, waveformContainer.clientWidth, waveformContainer.clientHeight);

                const barWidth = (waveformContainer.clientWidth / currentFreqArray.length) * 2.5;
                const maxHeight = waveformContainer.clientHeight * 0.8;
                let x = 0;

                for (let i = 0; i < currentFreqArray.length; i++) {
                    const rawValue = currentFreqArray[i];
                    const normalizedLinearValue = rawValue / 255;
                    const normalizedNonLinearValue = Math.sqrt(normalizedLinearValue);
                    const barHeight = normalizedNonLinearValue * maxHeight;

                    const hue = (i / currentFreqArray.length) * 120;
                    ctx.fillStyle = `hsl(${120 - hue}, 100%, 50%)`;
                    ctx.fillRect(x, waveformContainer.clientHeight - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }

            volumeLevel.style.width = `${volumePercent}%`;
            if (volumePercent <= 60) {
                volumeLevel.style.backgroundColor = '#30d158';
            } else if (volumePercent <= 85) {
                volumeLevel.style.backgroundColor = '#ff9f0a';
            } else {
                volumeLevel.style.backgroundColor = '#ff453a';
            }
        }

        function updateRecordTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            timerDisplay.textContent = formatTime(elapsed);
        }

        function initPlaybackAnalyser() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (playAnalyser && playFreqArray) {
                return;
            }
            playAnalyser = audioContext.createAnalyser();
            playAnalyser.fftSize = 2048;
            playFreqArray = new Uint8Array(playAnalyser.frequencyBinCount);

            try {
                const source = audioContext.createMediaElementSource(audioPlayback);
                source.connect(playAnalyser);
                playAnalyser.connect(audioContext.destination);
            } catch (err) {
                status.textContent = 'æ’­æ”¾åˆ†æå™¨åˆå§‹åŒ–å¤±è´¥ï¼š' + err.message;
                status.classList.add('error');
            }
        }

        async function captureAudioStream(deviceId = null) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            try {
                // ä¿®æ­£å¤§å°å†™ï¼šnavigator.mediaDevices.getUserMedia()
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: deviceId ? { deviceId: { exact: deviceId }, echoCancellation: true } : { echoCancellation: true }
                });

                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                freqArray = new Uint8Array(analyser.frequencyBinCount);

                status.textContent = 'æ•è·å£°éŸ³ä¸­ï¼ˆæœªå½•éŸ³ï¼‰';
                startBtn.disabled = false;
            } catch (err) {
                if (err.name === 'NotAllowedError') {
                    const tip = isSafari() 
                        ? 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·å‰å¾€ã€Œè®¾ç½® â†’ Safari â†’ éº¦å…‹é£ã€å¼€å¯'
                        : 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·å‰å¾€æµè§ˆå™¨è®¾ç½®å¼€å¯éº¦å…‹é£æƒé™';
                    status.textContent = tip;
                } else if (err.name === 'NotFoundError') {
                    status.textContent = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œè¯·æ£€æŸ¥ç¡¬ä»¶è¿æ¥';
                } else if (err.name === 'NotReadableError') {
                    status.textContent = 'éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨ï¼Œè¯·å…³é—­å ç”¨ç¨‹åºåé‡è¯•';
                } else {
                    status.textContent = 'æ•è·å£°éŸ³å¤±è´¥ï¼š' + err.message;
                }
                status.classList.add('error');
                startBtn.disabled = true;
            }
        }

        function initMediaRecorder() {
            if (!stream || mediaRecorder) return;

            // Safari æ”¯æŒçš„æ ¼å¼ä¼˜å…ˆ
            const SUPPORTED_MIME_TYPES = ['audio/mp4;codecs=mp4a.40.2', 'audio/m4a', 'audio/webm;codecs=opus'];
            let mimeType = '';
            for (const type of SUPPORTED_MIME_TYPES) {
                if (MediaRecorder.isTypeSupported(type)) {
                    mimeType = type;
                    break;
                }
            }
            if (!mimeType) mimeType = 'audio/webm';

            mediaRecorder = new MediaRecorder(stream, { mimeType });
            const chunks = [];

            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) chunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
                recordedBlob = new Blob(chunks, { type: mimeType });
                audioPlayback.src = URL.createObjectURL(recordedBlob);
                saveBtn.disabled = false;
                isRecording = false;
                timerDisplay.textContent = formatPlayTime(0, audioTotalDuration || 0);
                status.textContent = 'å½•åˆ¶å®Œæˆï¼Œå¯è¯•å¬æˆ–ä¿å­˜ï¼ˆä»åœ¨æ•è·å£°éŸ³ï¼‰';
                clearInterval(timerInterval);
            };
        }

        function toggleFullscreen() {
            const isFullscreen = !!document.fullscreenElement || !!document.webkitFullscreenElement;

            if (!isFullscreen) {
                if (waveformContainer.requestFullscreen) {
                    waveformContainer.requestFullscreen();
                } else if (waveformContainer.webkitRequestFullScreen) {
                    waveformContainer.webkitRequestFullScreen();
                }
                fullscreenBtn.innerHTML = 'âŒ';
                fullscreenBtn.title = 'é€€å‡ºå…¨å±é¢‘ç‡å›¾';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                fullscreenBtn.innerHTML = 'â›¶';
                fullscreenBtn.title = 'å…¨å±é¢‘ç‡å›¾';
            }
            resizeCanvas();
        }

        function handleFullscreenChange() {
            const isFullscreen = !!document.fullscreenElement || !!document.webkitFullscreenElement;

            if (isFullscreen) {
                fullscreenBtn.innerHTML = 'âŒ';
                fullscreenBtn.title = 'é€€å‡ºå…¨å±é¢‘ç‡å›¾';
            } else {
                fullscreenBtn.innerHTML = 'â›¶';
                fullscreenBtn.title = 'å…¨å±é¢‘ç‡å›¾';
            }
            resizeCanvas();
        }

        // äº‹ä»¶ç»‘å®š
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        micSelect.addEventListener('change', () => {
            if (micSelect.value) {
                captureAudioStream(micSelect.value);
            }
        });
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        allowMicBtn.addEventListener('click', async () => {
            permissionModal.classList.remove('show');
            await loadMicrophonesAndCapture();
        });
        startBtn.onclick = () => {
            if (!stream || isRecording) return;
            initMediaRecorder();
            if (!mediaRecorder) return;
            mediaRecorder.start();
            isRecording = true;
            startTime = Date.now();
            timerInterval = setInterval(updateRecordTimer, 200);
            startBtn.disabled = true;
            stopBtn.disabled = false;
            saveBtn.disabled = true;
            status.textContent = 'æ­£åœ¨å½•åˆ¶ä¸­ï¼ˆåŒæ—¶æ•è·å£°éŸ³ï¼‰';
        };
        stopBtn.onclick = () => {
            if (mediaRecorder?.state === 'recording') {
                mediaRecorder.stop();
            }
            startBtn.disabled = false;
            stopBtn.disabled = true;
        };
        saveBtn.onclick = () => {
            if (!recordedBlob) return;
            const url = URL.createObjectURL(recordedBlob);
            const a = document.createElement('a');
            a.href = url;
            const ext = recordedBlob.type.includes('mp4') ? 'm4a' : 'webm';
            a.download = `å½•éŸ³_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.${ext}`;
            a.click();
            URL.revokeObjectURL(url);
            status.textContent = 'å·²ä¿å­˜å½•éŸ³æ–‡ä»¶ï¼ˆä»åœ¨æ•è·å£°éŸ³ï¼‰';
        };
        audioPlayback.addEventListener('loadedmetadata', () => {
            audioTotalDuration = audioPlayback.duration || 0;
            if (!isRecording) {
                timerDisplay.textContent = formatPlayTime(0, audioTotalDuration);
            }
        });
        audioPlayback.addEventListener('play', async () => {
            isPlaying = true;
            if (audioContext && audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            initPlaybackAnalyser();
            status.textContent = 'æ­£åœ¨æ’­æ”¾å½•éŸ³ï¼ˆæš‚åœæ•è·å£°éŸ³ï¼‰';
        });
        audioPlayback.addEventListener('pause', () => {
            isPlaying = false;
            status.textContent = 'æ’­æ”¾å·²æš‚åœï¼ˆæ¢å¤æ•è·å£°éŸ³ï¼‰';
        });
        audioPlayback.addEventListener('ended', () => {
            isPlaying = false;
            status.textContent = 'æ’­æ”¾å·²ç»“æŸï¼ˆæ¢å¤æ•è·å£°éŸ³ï¼‰';
            timerDisplay.textContent = formatPlayTime(0, audioTotalDuration);
        });
        audioPlayback.addEventListener('timeupdate', () => {
            if (!isRecording && audioTotalDuration > 0) {
                timerDisplay.textContent = formatPlayTime(audioPlayback.currentTime, audioTotalDuration);
            }
        });
    </script>
</body>
</html>